<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Mentions</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
        }
        .editor { 
            border: 1px solid #ccc; 
            padding: 10px; 
            min-height: 100px; 
            margin: 10px 0; 
            background: white;
        }
        .dropdown {
            border: 1px solid #ddd;
            background: white;
            position: absolute;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            width: 200px;
        }
        .user-item {
            padding: 8px;
            cursor: pointer;
        }
        .user-item:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>Test Mentions Functionality</h1>
    
    <h2>Editor 1 (ProseMirror-like)</h2>
    <div class="editor ProseMirror" contenteditable="true" data-composer>
        Type @ to trigger mentions...
    </div>
    
    <h2>Editor 2 (General contenteditable)</h2>
    <div class="editor" contenteditable="true">
        Type @ to trigger mentions...
    </div>
    
    <div id="dropdown" class="dropdown" style="display: none;">
        <div class="user-item" onclick="selectUser('john_doe')">@john_doe</div>
        <div class="user-item" onclick="selectUser('jane_smith')">@jane_smith</div>
        <div class="user-item" onclick="selectUser('admin_user')">@admin_user</div>
    </div>

    <script>
        // Simulate the global variables from the original code
        let dropdownActive = false;
        let atSymbolPosition = null;
        let insertingMention = false;

        // Mock Livewire object for testing
        window.Livewire = {
            on: function(eventName, callback) {
                if (!window._livewireEvents) {
                    window._livewireEvents = {};
                }
                window._livewireEvents[eventName] = callback;
                console.log('Livewire.on registered:', eventName);
            },
            dispatch: function(eventName, data) {
                console.log('Livewire.dispatch called:', eventName, data);
            }
        };

        // Simplified version of the insertMention function
        function insertMention(editor, username) {
            console.log('üöÄ insertMention called with:', { 
                editor: editor.tagName || editor.nodeName, 
                username: username 
            });
            
            if (!username || username === 'undefined') {
                console.log('‚ùå Invalid username:', username);
                return;
            }
            
            insertingMention = true;
            
            try {
                const text = editor.textContent || '';
                const atIndex = text.lastIndexOf('@');
                
                console.log('üìù Current text:', text);
                console.log('üìç @ position:', atIndex);
                
                if (atIndex !== -1) {
                    const beforeAt = text.substring(0, atIndex);
                    const textFromAt = text.substring(atIndex);
                    
                    // Find where the partial mention ends by looking for space or newline
                    const spaceIndex = textFromAt.indexOf(' ');
                    const newlineIndex = textFromAt.indexOf('\n');
                    
                    // Find the first occurrence of space or newline (whichever comes first)
                    let endIndex = textFromAt.length; // Default to end of text
                    if (spaceIndex !== -1) endIndex = Math.min(endIndex, spaceIndex);
                    if (newlineIndex !== -1) endIndex = Math.min(endIndex, newlineIndex);
                    
                    const afterPartial = text.substring(atIndex + endIndex);
                    
                    const newText = beforeAt + '@' + username + ' ' + afterPartial;
                    
                    console.log('‚úÖ Replacing text:', {
                        before: beforeAt,
                        textFromAt: textFromAt,
                        endIndex: endIndex,
                        afterPartial: afterPartial,
                        newText: newText
                    });
                    
                    editor.textContent = newText;
                    
                    // Set cursor position after the mention
                    setTimeout(() => {
                        const mentionLength = username.length + 2; // @ + username + space
                        const newPosition = atIndex + mentionLength;
                        
                        // Simple cursor positioning
                        const range = document.createRange();
                        const selection = window.getSelection();
                        
                        if (editor.firstChild) {
                            const safePosition = Math.min(newPosition, editor.firstChild.textContent.length);
                            range.setStart(editor.firstChild, safePosition);
                            range.collapse(true);
                            selection.removeAllRanges();
                            selection.addRange(range);
                        }
                        
                        editor.focus();
                    }, 50);
                }
            } catch (error) {
                console.error('‚ùå Error in insertMention:', error);
            } finally {
                setTimeout(() => {
                    insertingMention = false;
                }, 100);
            }
        }

        // Setup global userSelected listener (simplified version)
        function setupGlobalUserSelectedListener() {
            console.log('üöÄ Setting up global userSelected listener');
            
            if (window.userSelectedListenerSetup) {
                console.log('‚ö†Ô∏è Global listener already exists, skipping');
                return;
            }
            
            window.userSelectedListenerSetup = true;
            
            Livewire.on('userSelected', function(data) {
                console.log('üéØ Global userSelected event received:', data);
                
                dropdownActive = false;
                atSymbolPosition = null;
                
                // Find active editor
                let activeEditor = document.querySelector('[contenteditable="true"]:focus') ||
                                 document.querySelector('[data-composer]') ||
                                 document.querySelector('.editor');
                
                console.log('üéØ Found active editor:', activeEditor ? {
                    tagName: activeEditor.tagName,
                    className: activeEditor.className
                } : null);
                
                if (activeEditor && data.username) {
                    console.log('‚úÖ Calling insertMention with:', {
                        editor: activeEditor.tagName,
                        username: data.username
                    });
                    
                    insertMention(activeEditor, data.username);
                } else {
                    console.log('‚ùå No active editor found or no username provided', {
                        hasEditor: !!activeEditor,
                        hasUsername: !!data.username,
                        data: data
                    });
                }
                
                // Hide dropdown
                document.getElementById('dropdown').style.display = 'none';
            });
        }

        // Test function to simulate user selection
        function selectUser(username) {
            console.log('üñ±Ô∏è User clicked on:', username);
            
            // Simulate the Livewire event dispatch
            if (window._livewireEvents && window._livewireEvents.userSelected) {
                window._livewireEvents.userSelected({
                    username: username,
                    userId: Math.floor(Math.random() * 1000)
                });
            }
        }

        // Setup mention detection for @ symbol
        function setupMentionDetection() {
            document.querySelectorAll('.editor').forEach(editor => {
                editor.addEventListener('input', function(e) {
                    if (insertingMention) return;
                    
                    const text = editor.textContent || '';
                    const atIndex = text.lastIndexOf('@');
                    
                    if (atIndex !== -1 && text.substring(atIndex).indexOf(' ') === -1) {
                        // Show dropdown
                        const dropdown = document.getElementById('dropdown');
                        const rect = editor.getBoundingClientRect();
                        dropdown.style.display = 'block';
                        dropdown.style.left = rect.left + 'px';
                        dropdown.style.top = (rect.bottom + 5) + 'px';
                        
                        console.log('üìç Showing dropdown at @ position');
                        dropdownActive = true;
                    } else if (dropdownActive && text.lastIndexOf('@') === -1) {
                        // Hide dropdown if no @ symbol
                        document.getElementById('dropdown').style.display = 'none';
                        dropdownActive = false;
                    }
                });
            });
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing test page');
            setupGlobalUserSelectedListener();
            setupMentionDetection();
            
            // Add some test instructions
            console.log('üìù Instructions:');
            console.log('1. Click in an editor');
            console.log('2. Type @');
            console.log('3. Click on a user from the dropdown');
            console.log('4. Check console for debugging info');
        });
    </script>
</body>
</html>
